## 远程服务器监控面板实现方案

### 适用系统
Debian GNU/Linux 12 (bookworm)

### 整体架构
1. **数据采集层**：使用Python脚本定期收集CPU、内存、硬盘、网络等系统资源数据
2. **数据存储层**：MySQL数据库存储历史监控数据
3. **数据展示层**：基于Flask的Web应用，提供实时和历史数据查询、图表展示

### 实现步骤

#### 1. 安装MySQL服务器
```bash
# 更新系统包列表
apt update

# 安装MySQL服务器
apt install -y mysql-server

# 启动并启用MySQL服务
systemctl start mysql
systemctl enable mysql

# 安全配置（设置root密码：!A33b3e561fec）
mysql_secure_installation
```

#### 2. 创建监控数据库和表
```sql
-- 创建监控数据库
CREATE DATABASE monitor;

-- 创建监控用户并授权
CREATE USER 'monitor'@'localhost' IDENTIFIED BY 'monitor123';
GRANT ALL PRIVILEGES ON monitor.* TO 'monitor'@'localhost';
FLUSH PRIVILEGES;

-- 切换到监控数据库
USE monitor;

-- 创建系统资源监控表
CREATE TABLE system_metrics (
    id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME NOT NULL,
    cpu_percent FLOAT NOT NULL,
    memory_total BIGINT NOT NULL,
    memory_used BIGINT NOT NULL,
    memory_free BIGINT NOT NULL,
    disk_total BIGINT NOT NULL,
    disk_used BIGINT NOT NULL,
    disk_free BIGINT NOT NULL,
    network_sent BIGINT NOT NULL,
    network_recv BIGINT NOT NULL
);
```

#### 3. 开发数据采集脚本
创建`monitor_collector.py`，使用`psutil`库采集系统资源数据：
```python
import psutil
import mysql.connector
import time
from datetime import datetime

# MySQL连接配置
DB_CONFIG = {
    'host': 'localhost',
    'user': 'monitor',
    'password': 'monitor123',
    'database': 'monitor'
}

# 采集间隔（秒）
INTERVAL = 60

def collect_metrics():
    """
    采集系统资源指标
    """
    # CPU使用率
    cpu_percent = psutil.cpu_percent(interval=1)
    
    # 内存使用情况
    memory = psutil.virtual_memory()
    
    # 磁盘使用情况（根目录）
    disk = psutil.disk_usage('/')
    
    # 网络IO情况
    network = psutil.net_io_counters()
    
    return {
        'timestamp': datetime.now(),
        'cpu_percent': cpu_percent,
        'memory_total': memory.total,
        'memory_used': memory.used,
        'memory_free': memory.free,
        'disk_total': disk.total,
        'disk_used': disk.used,
        'disk_free': disk.free,
        'network_sent': network.bytes_sent,
        'network_recv': network.bytes_recv
    }

def insert_metrics(metrics):
    """
    将监控指标插入数据库
    """
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    query = """
    INSERT INTO system_metrics (
        timestamp, cpu_percent, memory_total, memory_used, memory_free,
        disk_total, disk_used, disk_free, network_sent, network_recv
    ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
    """
    
    values = (
        metrics['timestamp'], metrics['cpu_percent'],
        metrics['memory_total'], metrics['memory_used'], metrics['memory_free'],
        metrics['disk_total'], metrics['disk_used'], metrics['disk_free'],
        metrics['network_sent'], metrics['network_recv']
    )
    
    cursor.execute(query, values)
    conn.commit()
    
    cursor.close()
    conn.close()

def main():
    """
    主函数，定期采集并存储监控数据
    """
    while True:
        metrics = collect_metrics()
        insert_metrics(metrics)
        time.sleep(INTERVAL)

if __name__ == "__main__":
    main()
```

#### 4. 安装依赖并启动采集服务
```bash
# 安装Python依赖
apt install -y python3-pip
pip3 install psutil mysql-connector-python

# 将采集脚本设置为系统服务
cat > /etc/systemd/system/monitor-collector.service << EOF
[Unit]
Description=System Monitor Collector
After=mysql.service

[Service]
Type=simple
User=root
ExecStart=/usr/bin/python3 /root/monitor_collector.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动并启用采集服务
systemctl daemon-reload
systemctl start monitor-collector
systemctl enable monitor-collector
```

#### 5. 开发Web监控面板
创建Flask应用，包括：
- `app.py`：Web应用主程序
- `templates/index.html`：监控页面模板
- `static/css/style.css`：样式文件

**app.py**：
```python
from flask import Flask, render_template, request
import mysql.connector
from datetime import datetime, timedelta
import json

app = Flask(__name__)

# MySQL连接配置
DB_CONFIG = {
    'host': 'localhost',
    'user': 'monitor',
    'password': 'monitor123',
    'database': 'monitor'
}

@app.route('/')
def index():
    # 默认时间范围为2小时
    time_range = request.args.get('time_range', '2h')
    
    # 解析时间范围
    if time_range.endswith('h'):
        hours = int(time_range[:-1])
        start_time = datetime.now() - timedelta(hours=hours)
    elif time_range.endswith('d'):
        days = int(time_range[:-1])
        start_time = datetime.now() - timedelta(days=days)
    elif time_range.endswith('w'):
        weeks = int(time_range[:-1])
        start_time = datetime.now() - timedelta(weeks=weeks)
    else:
        # 默认为2小时
        start_time = datetime.now() - timedelta(hours=2)
    
    # 查询数据库获取监控数据
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor(dictionary=True)
    
    query = """
    SELECT * FROM system_metrics 
    WHERE timestamp >= %s 
    ORDER BY timestamp ASC
    """
    
    cursor.execute(query, (start_time,))
    metrics = cursor.fetchall()
    
    cursor.close()
    conn.close()
    
    # 转换为前端所需格式
    timestamps = [m['timestamp'].strftime('%Y-%m-%d %H:%M:%S') for m in metrics]
    cpu_data = [m['cpu_percent'] for m in metrics]
    memory_used = [m['memory_used'] / (1024**3) for m in metrics]  # 转换为GB
    memory_total = [m['memory_total'] / (1024**3) for m in metrics]  # 转换为GB
    disk_used = [m['disk_used'] / (1024**3) for m in metrics]  # 转换为GB
    disk_total = [m['disk_total'] / (1024**3) for m in metrics]  # 转换为GB
    network_sent = [m['network_sent'] / (1024**2) for m in metrics]  # 转换为MB
    network_recv = [m['network_recv'] / (1024**2) for m in metrics]  # 转换为MB
    
    return render_template('index.html', 
                          timestamps=json.dumps(timestamps),
                          cpu_data=json.dumps(cpu_data),
                          memory_used=json.dumps(memory_used),
                          memory_total=json.dumps(memory_total),
                          disk_used=json.dumps(disk_used),
                          disk_total=json.dumps(disk_total),
                          network_sent=json.dumps(network_sent),
                          network_recv=json.dumps(network_recv),
                          current_time_range=time_range)

if __name__ == '__main__':
    # 监听所有IP，端口8080
    app.run(host='0.0.0.0', port=8080, debug=False)
```

**templates/index.html**：
```html
<!DOCTYPE html>
<html>
<head>
    <title>系统监控面板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>系统监控面板</h1>
        
        <div class="time-range">
            <label>时间范围：</label>
            <select onchange="window.location.href='/?time_range='+this.value">
                <option value="2h" {{ 'selected' if current_time_range == '2h' else '' }}>2小时</option>
                <option value="24h" {{ 'selected' if current_time_range == '24h' else '' }}>24小时</option>
                <option value="7d" {{ 'selected' if current_time_range == '7d' else '' }}>7天</option>
                <option value="30d" {{ 'selected' if current_time_range == '30d' else '' }}>30天</option>
            </select>
        </div>
        
        <div class="charts">
            <div class="chart-item">
                <h2>CPU使用率</h2>
                <canvas id="cpuChart"></canvas>
            </div>
            
            <div class="chart-item">
                <h2>内存使用</h2>
                <canvas id="memoryChart"></canvas>
            </div>
            
            <div class="chart-item">
                <h2>磁盘使用</h2>
                <canvas id="diskChart"></canvas>
            </div>
            
            <div class="chart-item">
                <h2>网络流量</h2>
                <canvas id="networkChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // 解析数据
        const timestamps = {{ timestamps|safe }};
        const cpuData = {{ cpu_data|safe }};
        const memoryUsed = {{ memory_used|safe }};
        const memoryTotal = {{ memory_total|safe }};
        const diskUsed = {{ disk_used|safe }};
        const diskTotal = {{ disk_total|safe }};
        const networkSent = {{ network_sent|safe }};
        const networkRecv = {{ network_recv|safe }};
        
        // 通用图表配置
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute'
                    }
                }
            }
        };
        
        // CPU使用率图表
        new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: 'CPU使用率(%)',
                    data: cpuData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: chartConfig
        });
        
        // 内存使用图表
        new Chart(document.getElementById('memoryChart'), {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: '已用内存(GB)',
                    data: memoryUsed,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                }, {
                    label: '总内存(GB)',
                    data: memoryTotal,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1
                }]
            },
            options: chartConfig
        });
        
        // 磁盘使用图表
        new Chart(document.getElementById('diskChart'), {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: '已用磁盘(GB)',
                    data: diskUsed,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.1)',
                    tension: 0.1
                }, {
                    label: '总磁盘(GB)',
                    data: diskTotal,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }]
            },
            options: chartConfig
        });
        
        // 网络流量图表
        new Chart(document.getElementById('networkChart'), {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: '上传流量(MB)',
                    data: networkSent,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }, {
                    label: '下载流量(MB)',
                    data: networkRecv,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                }]
            },
            options: chartConfig
        });
    </script>
</body>
</html>
```

**static/css/style.css**：
```css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
}

.time-range {
    text-align: center;
    margin-bottom: 30px;
}

.time-range label {
    font-size: 18px;
    margin-right: 10px;
}

.time-range select {
    padding: 8px 12px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
}

.charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
}

.chart-item {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chart-item h2 {
    font-size: 18px;
    margin-bottom: 15px;
    color: #34495e;
}

.chart-item canvas {
    height: 300px !important;
}
```

#### 6. 安装Web应用依赖并启动服务
```bash
# 安装Flask和MySQL驱动
pip3 install flask mysql-connector-python

# 将Web应用设置为系统服务
cat > /etc/systemd/system/monitor-web.service << EOF
[Unit]
Description=System Monitor Web Panel
After=mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/monitor-web
ExecStart=/usr/bin/python3 app.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动并启用Web服务
systemctl daemon-reload
systemctl start monitor-web
systemctl enable monitor-web
```

#### 7. 配置防火墙允许访问
```bash
# 允许8080端口访问
ufw allow 8080/tcp
ufw reload
```

### 预期效果
1. 监控数据每60秒采集一次，存储到MySQL数据库
2. Web监控面板通过 `http://服务器IP:8080` 访问
3. 支持2小时、24小时、7天、30天等时间范围的数据查询
4. 实时展示CPU、内存、硬盘、网络等系统资源使用情况
5. 图表化展示历史数据趋势

### 后续优化
1. 添加数据保留策略，定期清理旧数据
2. 增加告警功能，当资源使用率超过阈值时发送通知
3. 优化Web界面，支持更多自定义时间范围
4. 增加更多监控指标，如进程状态、系统负载等
5. 添加用户认证，提高安全性

### 注意事项
- 定期备份监控数据库，防止数据丢失
- 根据服务器性能调整数据采集间隔
- 考虑使用Nginx作为反向代理，提高Web应用的性能和安全性
- 监控Web应用本身的资源使用情况